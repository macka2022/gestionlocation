<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="fr">
<head>
    <meta charset="UTF-8" />
    <title>Statistiques - Gestion Location</title>

    <!-- CSS -->
    <link rel="stylesheet" th:href="@{/vendors/styles/core.css}" />
    <link rel="stylesheet" th:href="@{/vendors/styles/icon-font.min.css}" />
    <link rel="stylesheet" th:href="@{/src/plugins/jquery-steps/jquery.steps.css}" />
    <link rel="stylesheet" th:href="@{/src/plugins/datatables/css/dataTables.bootstrap4.min.css}" />
    <link rel="stylesheet" th:href="@{/src/plugins/datatables/css/responsive.bootstrap4.min.css}" />
    <link rel="stylesheet" th:href="@{/vendors/styles/style.css}" />

    <style>
        .kpi-card { border: 0; border-radius: 1rem; box-shadow: 0 6px 20px rgba(0,0,0,.08); }
        .kpi-value { font-size: 1.8rem; font-weight: 700; }
        .kpi-label { color: #6c757d; font-size: .9rem; }
    </style>
</head>
<body>

<div th:replace="~{fragments/header :: topbar}"></div>
<div th:replace="~{fragments/sidebar :: sidebar}"></div>

<div class="h-50 w-100"  ></div>
<div class="report-buttons" style="margin-top: 20px;">
    <a th:href="@{/report/pdf}"
       class="btn btn-primary"
       target="_blank">
        Télécharger PDF
    </a>

    <a th:href="@{/report/excel}"
       class="btn btn-success"
       target="_blank">
        Télécharger Excel
    </a>
</div>
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">Dashboard Administrateur</h1>
        <a href="/" class="btn btn-outline-secondary">Accueil</a>
    </div>

    <!-- KPIs -->
    <div class="row g-3">
        <div class="col-6 col-md-3">
            <div class="card kpi-card p-3">
                <div class="kpi-label">Utilisateurs</div>
                <div class="kpi-value" th:text="${vm.totalUsers}">0</div>
                <div class="small text-muted">
                    Propriétaires: <span th:text="${vm.totalOwners}">0</span> · Locataires: <span th:text="${vm.totalTenants}">0</span>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card kpi-card p-3">
                <div class="kpi-label">Immeubles</div>
                <div class="kpi-value" th:text="${vm.totalBuildings}">0</div>
                <div class="small text-muted">Unités: <span th:text="${vm.totalUnits}">0</span></div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card kpi-card p-3">
                <div class="kpi-label">Occupation</div>
                <div class="kpi-value">
                    <span th:text="${vm.unitsOccupied}">0</span>/<span th:text="${vm.totalUnits}">0</span>
                </div>
                <div class="small text-muted">Disponibles: <span th:text="${vm.unitsAvailable}">0</span></div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card kpi-card p-3">
                <div class="kpi-label">Revenus</div>
                <div class="kpi-value" th:text="${#numbers.formatCurrency(vm.monthlyRevenue)}">0</div>
                <div class="small text-muted">YTD: <span th:text="${#numbers.formatCurrency(vm.ytdRevenue)}">0</span></div>
            </div>
        </div>
    </div>

    <!-- Graphs -->
    <div class="row g-3 mt-2">
        <div class="col-12 col-lg-6">
            <div class="card kpi-card p-3">
                <div class="d-flex justify-content-between">
                    <h2 class="h6 mb-3">Revenus — 12 derniers mois</h2>
                </div>
                <canvas id="revenueChart" height="220"></canvas>
            </div>
        </div>
        <div class="col-12 col-lg-6">
            <div class="card kpi-card p-3">
                <h2 class="h6 mb-3">Paiements — Payés vs Impayés</h2>
                <canvas id="paidDonut" height="220"></canvas>
                <div class="small text-muted mt-2">
                    En retard: <span class="text-danger" th:text="${vm.overduePayments}">0</span>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3 mt-2">
        <div class="col-12">
            <div class="card kpi-card p-3">
                <h2 class="h6 mb-3">Occupation par immeuble</h2>
                <canvas id="occupancyByBuilding" height="260"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- =============== Données Thymeleaf (→ JS natif) =============== -->
<script th:inline="javascript">
    /*<![CDATA[*/
    // List<YearMonth> ou List<String> (ex: "2025-08")
    const last12Raw        = /*[[${vm.last12Months}]]*/ [];
    const revenueData      = /*[[${vm.revenueByMonth}]]*/ [];
    const paidCount        = /*[[${vm.paidCount}]]*/ 0;
    const unpaidCount      = /*[[${vm.unpaidCount}]]*/ 0;
    // Map<String, long[]> -> { "Immeuble A":[3,7], "Immeuble B":[2,4], ... }
    const occupancyByBuild = /*[[${vm.occupancyByBuilding}]]*/ {};
    /*]]>*/
</script>

<!-- =============== Charge Chart.js (une seule fois) =============== -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

<!-- =============== Graphiques =============== -->
<script>
    // Attendre que tout soit chargé (y compris Chart.js)
    window.addEventListener('load', () => {
        if (typeof Chart === 'undefined') {
            console.error('Chart.js non chargé. Vérifie le CDN ou les bloqueurs.');
            return;
        }

        // Labels: accepte YearMonth objet OU string
        const last12Labels = (Array.isArray(last12Raw) ? last12Raw : []).map(m => {
            if (m && typeof m === 'object' && 'year' in m && 'monthValue' in m) {
                return `${m.year}-${String(m.monthValue).padStart(2,'0')}`;
            }
            return String(m); // déjà "YYYY-MM"
        });

        // Occupation map -> arrays
        const occLabels = Object.keys(occupancyByBuild || {});
        const availableData = occLabels.map(k => (occupancyByBuild[k] || [0,0])[0]);
        const occupiedData  = occLabels.map(k => (occupancyByBuild[k] || [0,0])[1]);

        const moneyFmt = v => new Intl.NumberFormat(undefined, { style: 'currency', currency: 'XOF' }).format(v);

        // Revenus 12 mois
        new Chart(document.getElementById('revenueChart'), {
            type: 'line',
            data: { labels: last12Labels, datasets: [{ label: 'Revenus', data: revenueData, tension: .3, fill: false }] },
            options: { plugins: { tooltip: { callbacks: { label: (ctx)=> moneyFmt(ctx.parsed.y) } } }, scales: { y: { beginAtZero: true } } }
        });

        // Donut payés / impayés
        new Chart(document.getElementById('paidDonut'), {
            type: 'doughnut',
            data: { labels: ['Payés', 'Impayés'], datasets: [{ data: [paidCount, unpaidCount] }] },
            options: { cutout: '60%' }
        });

        // Stack bar occupation par immeuble
        new Chart(document.getElementById('occupancyByBuilding'), {
            type: 'bar',
            data: {
                labels: occLabels,
                datasets: [
                    { label: 'Disponibles', data: availableData, stack: 'stack1' },
                    { label: 'Occupés',    data: occupiedData,  stack: 'stack1' }
                ]
            },
            options: { responsive: true, scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } } }
        });
    });
</script>

<!-- Autres scripts (ApexCharts, DataTables, etc.) -->
<script th:src="@{/src/plugins/apexcharts/apexcharts.min.js}"></script>
<script th:src="@{/vendors/scripts/apexcharts-setting.js}"></script>
<script th:src="@{/vendors/scripts/dashboard3.js}"></script>
<script th:src="@{/vendors/scripts/core.js}"></script>
<script th:src="@{/vendors/scripts/script.min.js}"></script>
<script th:src="@{/vendors/scripts/process.js}"></script>
<script th:src="@{/vendors/scripts/layout-settings.js}"></script>
<script th:src="@{/src/plugins/jquery-steps/jquery.steps.js}"></script>
<script th:src="@{/vendors/scripts/steps-setting.js}"></script>
<script th:src="@{/src/plugins/datatables/js/jquery.dataTables.min.js}"></script>
<script th:src="@{/src/plugins/datatables/js/dataTables.bootstrap4.min.js}"></script>
<script th:src="@{/src/plugins/datatables/js/dataTables.responsive.min.js}"></script>
<script th:src="@{/src/plugins/datatables/js/responsive.bootstrap4.min.js}"></script>

</body>
</html>
